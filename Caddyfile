{
	order rate_limit before reverse_proxy
}

dariolab.com, www.dariolab.com {
	log {
		output file /var/log/caddy/access.log {
			roll_size 10MiB
			roll_keep 10
		}
		format json
	}

	header {
		Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
		X-Frame-Options "DENY"
		X-Content-Type-Options "nosniff"
		-Server
	}

	rate_limit {
		# Global limit
		zone per_ip_global {
			key {remote_host}
			events 300
			window 10s
		}

		# App paths (stricter)
		zone per_ip_app {
			match {
				path /api-stress-test/* /ichiro-family-tree/* /shortly/* /ichiro-walks/* /portainer/*
			}
			key {remote_host}
			events 100
			window 10s
		}
	}

  # Allowed paths
  @allowed {
    path / /index.html
    path /assets/* /static/* /icons/*
    path /robots.txt /sitemap.xml /manifest.json /site.webmanifest
    path /apple-touch-icon*.png /.well-known/acme-challenge/*
    path /api-stress-test/* /ichiro-family-tree/* /shortly/* /ichiro-walks/* /portainer/*
  }

  # Everything NOT in @allowed â†’ 404 + marker header
  @notAllowed {
    not @allowed
  }
  header @notAllowed X-Unknown-Path "1"
  respond @notAllowed 404

	reverse_proxy gateway:8080
}
